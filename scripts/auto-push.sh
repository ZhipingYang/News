#!/bin/bash

# AI èµ„è®¯è‡ªåŠ¨æ¨é€è„šæœ¬
# ä½¿ç”¨æ–¹æ³•ï¼š./scripts/auto-push.sh

set -e

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•çš„çˆ¶ç›®å½•ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "$SCRIPT_DIR/.." && pwd )"

cd "$PROJECT_ROOT"

# åŠ è½½ç¯å¢ƒå˜é‡
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | grep -v '^$' | xargs)
fi

# æ£€æŸ¥æ˜¯å¦æœ‰ token
if [ -z "$GITHUB_TOKEN" ]; then
    echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° GITHUB_TOKEN"
    echo "è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ .env æ–‡ä»¶ä¸­é…ç½® GITHUB_TOKEN"
    echo ""
    echo "é…ç½®æ–¹æ³•ï¼š"
    echo "1. å¤åˆ¶ .env.example ä¸º .env"
    echo "2. åœ¨ .env ä¸­å¡«å…¥ä½ çš„ GitHub Personal Access Token"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
if [ -z "$(git status --porcelain)" ]; then
    echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
    exit 0
fi

# è·å–å½“å‰æ—¥æœŸ
DATE=$(date +%Y-%m-%d)

# Git æ“ä½œ
echo "ğŸ“¦ æ·»åŠ æ‰€æœ‰æ›´æ”¹..."
git add .

echo "ğŸ’¾ æäº¤æ›´æ”¹..."
git commit -m "Add AI news analysis for $DATE

Auto-generated by AI workflow
- AI Programming
- Generative AI
- AI Chips
- Quantum Computing
- Robotics" || true

echo "ğŸš€ æ¨é€åˆ° GitHub..."
# ä½¿ç”¨ token æ¨é€ï¼ˆä¸ä¼šæš´éœ²åœ¨å‘½ä»¤è¡Œå†å²ä¸­ï¼‰
git push https://${GITHUB_TOKEN}@github.com/ZhipingYang/News.git master 2>&1 | grep -v "$GITHUB_TOKEN" || true

echo ""
echo "âœ… æ¨é€æˆåŠŸï¼"
echo "ğŸŒ ç½‘ç«™å°†åœ¨ 2-3 åˆ†é’Ÿåæ›´æ–°ï¼šhttps://zhipingyang.github.io/News/"

